# This configuration defines two containers: one for the Redmine application
# and one for its database server. Right now all configuration is hardcoded and
# the setup is quite Vagrant-specific (probably could be mostly recycled for
# KVM, etc., but something like Docker would be different).
#
# We will need some way of flexibly configuring the IPs of the hosts and other
# facts about environment (e.g. database account, password, etc).  They should
# also be available as variables to be used in other parts of configuration
# (like `commands` key).

containers:
  application:
    # This defines the base box. The value can be one of the predefined base
    # boxes that we provide or another box in the same config.
    from: debian:jessie
    network:
      # The network addresses are hardcoded on the containers at the moment. We
      # probably want them to be part of the environment instead, but for now
      # this will do.
      ip: 10.8.10.8
      # Exposed ports that we want to be visible from the outside and other
      # containers (ignored for now).
      expose:
      - 3000
    require:
      # This container requires the database next to it in order to perform
      # initialisation and in order to operate.
      database:
      - init
      - run
    commands:
    # Each line is a shell command, all of them are run with the same shell.
    - &prep apt-get -y update
    - apt-get -y install debconf-utils
    - apt-get -y install --no-install-recommends redmine-pgsql
    - echo "redmine redmine/instances/default/dbconfig-install boolean false" |
      debconf-set-selections
    - mkdir -p /etc/redmine/default
    - |
      cat >/etc/redmine/default <<END
      production:
        adapter: postgresql
        database: redmine
        host: 10.8.10.9
        port: 5432
        username: redmine
        password: redpass
        encoding: utf8
      END
    - |
      cat >/etc/systemd/system/redmine.service <<END
      [Unit]
      Description=Redmine

      [Service]
      User=www-data
      Environment=X_DEBIAN_SITEID=default
      WorkingDirectory=/usr/share/redmine
      ExecStart=/usr/bin/ruby bin/rails server -e production
      END
    - DEBIAN_FRONTENT=noninteractive apt-get -y install redmine
    - mkdir -p /usr/share/redmine/tmp
    - chown www-data /usr/share/redmine/tmp
    - systemctl start redmine
  database:
    from: debian:jessie
    network:
      ip: 10.8.10.9
      expose:
      - 5432
    commands:
    # Also direct port from Vagrantfile.
    - *prep
    - apt-get -y install postgresql
    - |
      sudo -u postgres psql <<END
      create user redmine password 'redpass';
      create database redmine;
      grant all on database redmine to redmine;
      alter system set listen_addresses='*';
      END
    - |
      cat >>/etc/postgresql/9.4/main/pg_hba.conf <<END
      # Allow connections from Redmine application server.
      host    all             all             10.8.10.8/32            md5
      END
    - /etc/init.d/postgresql restart
