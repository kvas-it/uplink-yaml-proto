# This file is the second prototype of Uplink configuration for Redmine. The
# goal of this prototype is to be able to install, configure and run Redmine
# via Vagrant backend and to investigate the possibility of driving other
# backends (e.g. Docker, KVM) based on the same configuration.
#
# The configuration defines two containers: one for the Redmine application
# and one for the database server (PostgreSQL). Both contianers are based on
# Debian/Jessie base image (base images need to be provided for each backend).
# Unlike in the first prototype, the containers can now be installed
# independently. They are only connected together for creation of the database
# and for actual execution, which is defined via the new section called
# "tasks".

containers:
  application:
    # This defines the base box. The value can be one of the predefined base
    # boxes that we provide or another box in the same config.
    from: debian:jessie
    network:
      # The network addresses are hardcoded on the containers at the moment. We
      # probably want them to be part of the environment instead, but for now
      # this will do.
      ip: 10.8.10.8
      # Exposed ports that we want to be visible from the outside and other
      # containers (ignored for now).
      expose:
      - 3000
    commands:
    # Each line is a shell command, all of them are run with the same shell.
    - &prep apt-get -y update
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get -y install debconf-utils
    - apt-get -y install --no-install-recommends redmine-pgsql
    # Skip redmine post-install: see https://askubuntu.com/questions/482928
    - apt-get download redmine
    - dpkg --unpack redmine*.deb
    - rm -f /var/lib/dpkg/info/redmine.postinst redmine*.deb
    - apt-get install -yf
    # Create redmine service for systemd.
    - |
      cat >/etc/systemd/system/redmine.service <<END
      [Unit]
      Description=Redmine

      [Service]
      User=www-data
      Environment=X_DEBIAN_SITEID=default
      WorkingDirectory=/usr/share/redmine
      ExecStart=/usr/bin/ruby bin/rails server -e production
      END
    # Create temporary directory for redmine instance and adjust access rights.
    - mkdir -p /usr/share/redmine/tmp
    - chown www-data /usr/share/redmine/tmp
  database:
    from: debian:jessie
    network:
      ip: 10.8.10.9
      expose:
      - 5432
    commands:
    - *prep
    - apt-get -y install postgresql
tasks:
  init:
    - database:
      - |
        sudo -u postgres psql <<END
        create user redmine password 'redpass';
        create database redmine;
        grant all on database redmine to redmine;
        alter system set listen_addresses='*';
        END
      - |
        cat >>/etc/postgresql/9.4/main/pg_hba.conf <<END
        # Allow connections from Redmine application server.
        host    all             all             10.8.10.8/32            md5
        END
      - /etc/init.d/postgresql restart
    - application:
      - |
        mkdir -p /etc/redmine/default
        cat >/etc/redmine/default/database.yml <<END
        production:
          adapter: postgresql
          database: redmine
          host: 10.8.10.9
          port: 5432
          username: redmine
          password: redpass
          encoding: utf8
        END
      - cd /usr/share/redmine
      - export RAILS_ENV=production
      - ruby bin/rake generate_secret_token
      - ruby bin/rake db:migrate
  start-db:
    - database:
      - /etc/init.d/postgresql start
  start-app:
    - application:
      - systemctl start redmine
  start:
    - start-db
    - start-app
  test:
    - application:
      - echo 'Running hostname at application:'
      - hostname
    - database:
      - echo 'Running hostname at database:'
      - hostname
